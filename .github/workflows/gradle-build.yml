# Uses Eclipse Temurin (OpenJDK build) installed by actions/setup-java.
# Temurin is distributed under the GNU General Public License, version 2,
# with the Classpath Exception (GPLv2 + CPE).
# See: https://openjdk.org/legal/gplv2+ce.html
name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
<<<<<<< HEAD
  build:
    runs-on: ubuntu-22.04
    container: wpilib/ubuntu-base:22.04
=======
  spotless:
    name: Spotless
    runs-on: ubuntu-latest
>>>>>>> origin/Kfir2026

    steps:
      - name: Checkout
        uses: actions/checkout@v4
<<<<<<< HEAD
        
      - name: Add repository to git safe directories
        run: git config --global --add safe.directory $GITHUB_WORKSPACE
        
      - name: Fix gradlew line endings & permissions (if needed)
=======

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Fix gradlew permissions
        run: chmod +x ./gradlew

      - name: Spotless check
        run: ./gradlew spotlessCheck --no-daemon

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Fix gradlew permissions
        run: chmod +x ./gradlew

      - name: Compile
        run: ./gradlew compileJava compileTestJava --no-daemon

      # WPILib HAL native libs crash during JVM shutdown on Linux
      # (SIGSEGV in __libc_free, exit 134). All tests pass but the
      # forked test JVM exit is nonzero. This is a WPILib JNI bug.
      # Gradle does NOT produce XML results when the JVM crashes,
      # so we capture console output and parse PASSED/FAILED lines.
      - name: Run tests
        run: ./gradlew test --no-daemon 2>&1 | tee test-output.log || true

      - name: Verify test results
>>>>>>> origin/Kfir2026
        run: |
          # Match "testMethod() PASSED" or "testMethod() FAILED" â€” the ()
          # distinguishes real test results from Gradle's "> Task :test FAILED"
          PASSED=$(grep -c '() PASSED$' test-output.log || true)
          FAILED=$(grep -c '() FAILED$' test-output.log || true)
          if [ "$PASSED" -eq 0 ] && [ "$FAILED" -eq 0 ]; then
            echo "::error::No test results found in output. Tests may not have run."
            exit 1
          fi
<<<<<<< HEAD
          
      - name: Run Spotless Check
        #continue-on-error: true
        run: ./gradlew spotlessCheck
=======
          if [ "$FAILED" -gt 0 ]; then
            echo "::error::$FAILED test(s) failed:"
            grep '() FAILED$' test-output.log
            exit 1
          fi
          echo "All $PASSED tests passed"

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: test-output.log
          retention-days: 14
>>>>>>> origin/Kfir2026
